<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Product Messages</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 50px;
        }

        .card {
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: scale(1.02);
        }

        #messageList {
            margin-top: 30px;
        }

        .btn-send {
            background-color: #0d6efd;
            color: white;
        }

        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 2px;
        }

        #alertBox {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">MSA í”„ë¡œì íŠ¸</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">í™ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">ìƒí’ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/orders">ì£¼ë¬¸</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/boards">ê²Œì‹œíŒ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/rbmq1">RabbitMQ</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="authNav">
                    <li class="nav-item" id="loginNav">
                        <a class="nav-link" href="/login">ë¡œê·¸ì¸</a>
                    </li>
                    <li class="nav-item d-none" id="userNav">
                        <span class="nav-link" id="username"></span>
                    </li>
                    <li class="nav-item d-none" id="logoutNav">
                        <a class="nav-link" href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
<div class="container mt-4">
    <div class="card shadow-sm mb-4" style="border: none;">
        <div class="card-header bg-white border-bottom">
            <h3 class="mb-0 text-center">ğŸ° RabbitMQ ë©”ì‹œì§€ ì„¼í„°</h3>
        </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div id="alertBox" class="alert" role="alert"></div>

    <!-- ì…ë ¥ í¼ -->
    <div class="card shadow-sm p-4 mb-4" style="border: none;">
        <h4 class="mb-3">ğŸ“¨ ìƒˆ ë©”ì‹œì§€ ì „ì†¡</h4>
        <form id="messageForm">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" id="title" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" id="quantity" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Product Code</label>
                <input type="text" id="productCode" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Content</label>
                <textarea id="content" class="form-control" rows="3" required></textarea>
            </div>

            <button type="submit" class="btn btn-send w-100" id="sendBtn">
                ğŸš€ Send Message
            </button>
        </form>
    </div>

    <!-- ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ -->
    <div class="card shadow-sm" style="border: none;">
        <div class="card-header bg-white border-bottom">
            <h4 class="mb-0">ğŸ“œ ì „ì†¡ëœ ë©”ì‹œì§€</h4>
        </div>
        <div class="card-body">
            <div id="messageList" class="row"></div>
        </div>
    </div>
</div>

<script>
    console.log("ğŸš€ JS loaded once"); // ì¤‘ë³µ ë¡œë“œ ë””ë²„ê·¸ìš©

    const apiUrl = "/api/messages";

    // âœ… ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showAlert(message, type = "success") {
        const alertBox = document.getElementById("alertBox");
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.style.display = "block";
        setTimeout(() => alertBox.style.display = "none", 2500);
    }

    // âœ… ë©”ì‹œì§€ ëª©ë¡ ë¡œë“œ
    async function loadMessages() {
        try {
            const res = await fetch(apiUrl);
            const messages = await res.json();

            const list = document.getElementById("messageList");
            list.innerHTML = "";

            messages.reverse().forEach(msg => {
                const card = document.createElement("div");
                card.className = "col-md-4 mb-3";
                card.innerHTML = `
                    <div class="card p-3">
                        <h5>${msg.title}</h5>
                        <p><strong>Product:</strong> ${msg.productCode}</p>
                        <p><strong>Quantity:</strong> ${msg.quantity}</p>
                        <p>${msg.content}</p>
                    </div>
                `;
                list.appendChild(card);
            });
        } catch (err) {
            console.error("âŒ Failed to load messages:", err);
        }
    }

    // âœ… ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€ ë° ë“±ë¡
    function initFormHandler() {
        const form = document.getElementById("messageForm");
        const btn = document.getElementById("sendBtn");

        // ì´ì „ ì´ë²¤íŠ¸ ì œê±° (í•µì‹¬!)
        form.onsubmit = null;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Sending...`;

            const data = {
                title: document.getElementById("title").value,
                quantity: parseInt(document.getElementById("quantity").value),
                productCode: document.getElementById("productCode").value,
                content: document.getElementById("content").value
            };

            try {
                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showAlert("âœ… Message sent successfully!", "success");
                    form.reset();
                    await loadMessages();
                } else {
                    showAlert("âŒ Failed to send message", "danger");
                }
            } catch (error) {
                showAlert("âš ï¸ Network error occurred", "warning");
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "ğŸš€ Send Message";
            }
        });
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener("DOMContentLoaded", async () => {
        await loadMessages();
        initFormHandler();
        checkLoginStatus();
    });

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    function checkLoginStatus() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');

        if (token && username) {
            document.getElementById('loginNav').classList.add('d-none');
            document.getElementById('userNav').classList.remove('d-none');
            document.getElementById('logoutNav').classList.remove('d-none');
            document.getElementById('username').textContent = `${username} (${role})`;
        } else {
            document.getElementById('loginNav').classList.remove('d-none');
            document.getElementById('userNav').classList.add('d-none');
            document.getElementById('logoutNav').classList.add('d-none');
        }
    }

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        window.location.href = '/login';
    });
</script>
</body>
</html>
