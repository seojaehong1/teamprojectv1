<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>재고 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .low-stock {
            background-color: #fff3cd;
        }
        .out-of-stock {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">MSA 프로젝트</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">관리자 홈</a>
                <a class="nav-link" href="/">메인</a>
            </div>
        </div>
    </nav>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>재고 관리</h2>
            <button class="btn btn-primary" onclick="loadLowStock()">재고 부족 재료 조회</button>
        </div>

        <div class="table-container">
            <div class="alert alert-warning" role="alert">
                <strong>참고:</strong> 재고 조회/수정 API는 현재 미구현 상태입니다. API 구현 후 사용 가능합니다.
            </div>

            <div class="mb-3">
                <input type="text" class="form-control" id="searchInput" placeholder="재료명으로 검색..." onkeyup="filterMaterials()">
            </div>

            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>재료 ID</th>
                        <th>재료명</th>
                        <th>현재 재고량</th>
                        <th>단위</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr>
                        <td colspan="6" class="text-center">재고 목록을 불러오는 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 재고 수정 모달 -->
    <div class="modal fade" id="editInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">재고 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInventoryForm">
                        <input type="hidden" id="editMaterialId">
                        <div class="mb-3">
                            <label class="form-label">재료명</label>
                            <input type="text" class="form-control" id="editMaterialName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">현재 재고량</label>
                            <input type="text" class="form-control" id="editCurrentStock" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">단위</label>
                            <input type="text" class="form-control" id="editUnit" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editStockQty" class="form-label">변경할 재고량</label>
                            <input type="number" step="0.01" class="form-control" id="editStockQty" required>
                            <small class="form-text text-muted">양수: 입고, 음수: 출고</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updateInventory()">수정</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let allMaterials = [];

        // 재고 목록 로드 (API 미구현으로 예시 데이터 표시)
        async function loadInventory() {
            // TODO: API 구현 후 실제 호출
            // const response = await fetch(`${API_BASE_URL}/api/inventory/materials`);
            // allMaterials = await response.json();

            // 임시 예시 데이터
            allMaterials = [
                { ingredientId: 1, ingredientName: '커피원두', stockQty: 50.0, baseUnit: 'kg' },
                { ingredientId: 2, ingredientName: '우유', stockQty: 20.0, baseUnit: 'L' },
                { ingredientId: 3, ingredientName: '시럽', stockQty: 5.0, baseUnit: 'L' },
                { ingredientId: 4, ingredientName: '얼음', stockQty: 100.0, baseUnit: 'kg' }
            ];

            renderInventoryTable(allMaterials);
        }

        // 재고 테이블 렌더링
        function renderInventoryTable(materials) {
            const tbody = document.getElementById('inventoryTableBody');
            if (materials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">등록된 재고가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = materials.map(material => {
                const stockQty = material.stockQty || 0;
                let status = '정상';
                let rowClass = '';
                
                if (stockQty <= 0) {
                    status = '<span class="badge bg-danger">품절</span>';
                    rowClass = 'out-of-stock';
                } else if (stockQty < 10) {
                    status = '<span class="badge bg-warning">부족</span>';
                    rowClass = 'low-stock';
                } else {
                    status = '<span class="badge bg-success">정상</span>';
                }

                return `
                    <tr class="${rowClass}">
                        <td>${material.ingredientId}</td>
                        <td>${material.ingredientName}</td>
                        <td>${stockQty}</td>
                        <td>${material.baseUnit}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openEditModal(${material.ingredientId})">수정</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 재고 부족 재료 조회
        async function loadLowStock() {
            // TODO: API 구현 후 실제 호출
            // const response = await fetch(`${API_BASE_URL}/api/inventory/materials/low-stock`);
            // const lowStockMaterials = await response.json();
            
            const lowStockMaterials = allMaterials.filter(m => (m.stockQty || 0) < 10);
            renderInventoryTable(lowStockMaterials);
        }

        // 재료 검색 필터
        function filterMaterials() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMaterials.filter(m => 
                m.ingredientName.toLowerCase().includes(searchTerm)
            );
            renderInventoryTable(filtered);
        }

        // 수정 모달 열기
        function openEditModal(materialId) {
            const material = allMaterials.find(m => m.ingredientId === materialId);
            if (!material) {
                alert('재료 정보를 찾을 수 없습니다.');
                return;
            }

            document.getElementById('editMaterialId').value = material.ingredientId;
            document.getElementById('editMaterialName').value = material.ingredientName;
            document.getElementById('editCurrentStock').value = material.stockQty || 0;
            document.getElementById('editUnit').value = material.baseUnit;
            document.getElementById('editStockQty').value = '';

            new bootstrap.Modal(document.getElementById('editInventoryModal')).show();
        }

        // 재고 수정
        async function updateInventory() {
            const materialId = document.getElementById('editMaterialId').value;
            const changeQty = parseFloat(document.getElementById('editStockQty').value);
            const currentQty = parseFloat(document.getElementById('editCurrentStock').value);
            const newQty = currentQty + changeQty;

            if (newQty < 0) {
                alert('재고량은 0 이상이어야 합니다.');
                return;
            }

            // TODO: API 구현 후 실제 호출
            // const response = await fetch(`${API_BASE_URL}/api/inventory/materials/${materialId}`, {
            //     method: 'PUT',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({ stockQty: newQty })
            // });

            // 임시로 로컬 데이터 업데이트
            const material = allMaterials.find(m => m.ingredientId == materialId);
            if (material) {
                material.stockQty = newQty;
                renderInventoryTable(allMaterials);
                bootstrap.Modal.getInstance(document.getElementById('editInventoryModal')).hide();
                alert('재고가 수정되었습니다.');
            }
        }

        // 페이지 로드 시 재고 목록 불러오기
        document.addEventListener('DOMContentLoaded', loadInventory);
    </script>
</body>
</html>

